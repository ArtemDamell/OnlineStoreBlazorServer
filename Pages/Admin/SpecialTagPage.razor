@*Урок 2 (2.1) Назначаем маршрут до страницы*@
@page "/specialtag"
@page "/specialtag/{PageNumber:int}"
@*Урок 2 (4.2) Внедряем зависимость сервиса*@
@inject SpecialTagService specialTagServices
@*Урок 2 (6) Пишем разметку*@
@*6.1 Проверяем наш лист на null (во избежание NullReferenceException)*@

@*Урок 11 (6)*@
@*@attribute [Authorize(Roles = StaticData.AdminRole)]*@
@*Создаём заголовок и кнопку добавления категорий*@
<div class="container-fluid component-title p-4">
    <div class="row justify-content-between align-items-center">
        <div class="col-5">
            <h1 class="text-info">SpecialTag List</h1>
        </div>
        <div class="col-3 text-right">
            <button type="button" @onclick="AddNewSpecialTag" class="btn btn-info form-control">
                Add New Special Tag
            </button>
        </div>
    </div>


    @if (specialTags is null)
    {
        // Если null, то выводим блок информации о загрузке данных
        <div class="row">
            <div class="col text-center">
                @*<em>Loading specialTags ...</em>*@
                <img src="https://cdn.dribbble.com/users/108183/screenshots/5331825/loading_xxi.gif" height="200" />
            </div>
        </div>
    }
    else if (specialTags.Count > 0)
    {
        <PaginationComp Items="specialTags" PageNumber="PageNumber" TotalCount="totalCount" />
        <div class="row pt-4 table-r">
            <table class="table table-striped">
                <thead class="bg-info">
                    <tr>
                        <th>Special Tag Name</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in specialTags)
                    {
                        <tr>
                            <td>@item.Name</td>
                            <td class="text-right">
                                <button type="button" @onclick="(() => EditSpecialTag(item))" class="btn btn-primary">Edit</button>
                                @*Урок 3 (8)*@
                                <button type="button" @onclick="(() => DeleteSpecialTag(item))" class="btn btn-danger">Delete</button>
                            </td>
                        </tr>
                    }
                </tbody>
                <tfoot>
                    <tr class="text-right">
                        <td></td>
                        <td>SpecialTag count: @specialTags.Count</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    }
    else
    {
        <div class="row">
            <div class="col text-center">
                <img src="https://cdn.dribbble.com/users/1231865/screenshots/11157048/media/bc9427646c632ded563ee076fdc5dfda.jpg?compress=1&resize=800x600" height="200" />
            </div>
        </div>
    }

    @if (showPopUp)
    {
        <div class="modal fade show" tabindex="-1" style="display: block" role="dialog">
            @*Урок 3 (1)*@
            <EditForm Model="@specialTagObj" OnValidSubmit="@ValidSubmit">

                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            @*Урок 3 (6.3)*@
                            <h3 class="text-info">@(!specialTagObj.Id.Equals(0) ? "Update" : "Create") Special Tag</h3>
                            <button type="button" class="close" @onclick="ClosePopUp" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            @*Урок 3 (4)*@
                            <DataAnnotationsValidator />
                            <ValidationSummary />

                            <div class="¨row">
                                <div class="col-9">
                                    <div class="row py-2">
                                        <div class="col-4">
                                            SpecialTag Name
                                        </div>
                                        <div class="col-8">
                                            <input class="form-control" type="text" @bind="specialTagObj.Name" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" @onclick="ClosePopUp" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                </div>

            </EditForm>
        </div>
    }
</div>

@code {
    [Parameter] public int PageNumber { get; set; }

    // Урок 2 (5.1) Создаём лист для хранения категорий
    List<SpecialTag> specialTags;

    SpecialTag specialTagObj = new();
    bool showPopUp = false;

    int totalCount;

    // Урок 2 (5.2) Заполняем лист данными при инициализации компонента
    protected override void OnParametersSet()
    {
        if (PageNumber <= 0)
            PageNumber = 1;
        // Заполняем лист данными с помощью внедрённой зависимости
        specialTags = specialTagServices.GetPagedSpecialTagsAsync(PageNumber, 3, out totalCount);
    }

    void AddNewSpecialTag()
    {
        specialTagObj = new();
        // Урок 3 (6.1)
        specialTagObj.Id = 0;

        showPopUp = true;
    }

    // Урок 3 (6)
    void EditSpecialTag(SpecialTag catForEdit)
    {
        specialTagObj = catForEdit;
        showPopUp = true;
    }

    // Урок 3 (8)
    async Task DeleteSpecialTag(SpecialTag catForDelete)
    {
        var result = false;
        result = await specialTagServices.DeleteSpecialTagAsync(catForDelete);

        // Очищаем список категорий
        specialTags.Clear();

        // Обновляем список категорий для обновления таблицы
        specialTags = specialTagServices.GetPagedSpecialTagsAsync(PageNumber, 3, out totalCount);
    }

    void ClosePopUp()
    {
        showPopUp = false;
    }

    // Урок 3 (3)
    async Task ValidSubmit()
    {
        // 1 создаём переменную для хранения результата сохранения категории
        var result = false;

        // 2 скрываем PopUp
        showPopUp = false;

        // Урок 3 (6.2)
        if (specialTagObj.Id.Equals(0))
        {
            // 3 Вызываем метод сохранения и получаем результат
            result = await specialTagServices.CreateSpecialTagAsync(specialTagObj);
        }
        else
            result = await specialTagServices.UpdateSpecialTagAsync(specialTagObj);


        // 4 Обновляем список категорий
        specialTags = specialTagServices.GetPagedSpecialTagsAsync(PageNumber, 3, out totalCount);
    }
}
